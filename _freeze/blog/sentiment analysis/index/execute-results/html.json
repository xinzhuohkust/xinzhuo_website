{
  "hash": "3ec591277d6de133c5a4588caa0fcbaf",
  "result": {
    "markdown": "---\ntitle: \"Sentence Level Sentiment Analysis\"\ndate: \"last-modified\"\nauthor: Xinzhuo HUANG\ncategories: [R, Python, Sentiment Analysis, Reticulate]\ndescription: \"by calling Python in R\"\ncode-fold: show\n---\n\n```{=html}\n<style>\nbody {text-align: justify}\n</style>\n```\n\n\n![](images/sentiment.png)\n\nText analysis enables the identification and extraction of sentiment information from text. By leveraging tools such as `asent`, `sentimentr`, and basic sentiment lexicons, it is possible to construct a sentiment classifier that can estimate whether the underlying sentiment of a given text is positive, negative, or neutral.\n\n# Pacakage Management\n\nUsing `pacman` to manage package dependencies.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrequire(pacman)\np_load(dplyr, magrittr, furrr, purrr, DT, readr, stringr, furrr, purrr, sentimentr, tidyfst, tidyr, textclean, tidytext, tibble, kableExtra)\n```\n:::\n\n\n# Load Data\n\nOur demonstration data are sourced from a news dataset collected from Factiva, consisting of 500 observations. The \"link\" refers to the links of these news articles. These news articles have been translated into English and undergone thorough text cleaning. Please find the data [here.](https://drive.google.com/file/d/1JKj8rDatjionAYN1EhzFnSNBRNQkay0C/view){.external target=\"_blank\"}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- read_rds(\"E:/OneDrive - HKUST Connect/SOSC/paper_with_jean/group_meeting/fifth/data_for_analysis_share.Rds\")\nglimpse(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 500\nColumns: 2\n$ link         <chr> \"https://global.factiva.com/redir/default.aspx?P=sa&an=AF…\n$ cleaned_text <chr> \"the head of the women tennis association says that he is…\n```\n:::\n:::\n\n\n# Using asent\n\nTo use `asent`, a Python package in R, you need `reticulate` package to integrate Python code in your R script. You can change your python interpreter here:\n\n![](images/python_in_R.png){width=\"550\"}\n\n## install python packages:\n\nCall python in R.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreticulate::use_python(\"C:\\\\Users\\\\xhuangcb\\\\anaconda3\\\\envs\\\\pytorch_gpu\\\\python.exe\") # call python in R\n```\n:::\n\n\nThen:\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Tpying </th>\n   <th style=\"text-align:left;\"> To install </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> !pip install spacy </td>\n   <td style=\"text-align:left;\"> spacy </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> !pip install asent </td>\n   <td style=\"text-align:left;\"> asent </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> !pip install https://github.com/explosion/spacy-models/releases/download/en_core_web_lg-3.5.0/en_core_web_lg-3.5.0-py3-none-any.whl </td>\n   <td style=\"text-align:left;\"> pre-trained model </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n![](images/callpythoninr.png){width=\"550\"}\n\n## from OOP to FP\n\nPython is an object-oriented programming (OOP) language, and it is possible to convert Python classes into functions in R, which mainly support functional programming (FP).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspacy <- reticulate::import(\"spacy\") # load spacy\n\nasent <- reticulate::import(\"asent\") # load asent\n\nnlp <- spacy$load(\"en_core_web_lg\") # load pre-trained model\n\nnlp$add_pipe(\"asent_en_v1\") # add asent pipe\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<asent.component.Asent object at 0x000002306EFBD5E0>\n```\n:::\n\n```{.r .cell-code}\nnlp_safe <- possibly(.f = nlp, otherwise = \"error!\") # error handling\n\nget_polarity <- nlp_safe(\"sentiment\")$get_extension(\"polarity\")[[3]] # load python function\n\nget_sentiment_asent <- \\(x) {\n    result <- nlp_safe(x) %>%\n        get_polarity() %>%\n        print() %>%\n        capture.output() %>%\n        str_extract_all(\"-?0\\\\.\\\\d+\") %>%\n        unlist() %>%\n        as.numeric()\n\n    names(result) <- c(\"neg\", \"neu\", \"pos\", \"compound\")\n\n    return(result)\n}\n```\n:::\n\n\nTry our function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_sentiment_asent(data$cleaned_text[1])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     neg      neu      pos compound \n  0.0440   0.6350   0.0710   0.1235 \n```\n:::\n:::\n\n\nIt is an analytical process of asent:\n\n![](images/result-01.png){width=\"680\"}\n\n# Using sentimentr\n\nOur function using `sentimentr`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_sentences_safe <- possibly(.f = get_sentences, otherwise = \"error!\") # sentences cutter\n\nsentiment_by_safe <- possibly(.f = sentiment_by, otherwise = \"error!\") # sentiment classifier\n\nget_sentiemnt_sentimentr <- \\(x) {\n    x %>%\n        get_sentences_safe() %>%\n        sentiment_by_safe() %>%\n        unlist()\n}\n```\n:::\n\n\nTry it:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_sentiemnt_sentimentr(data$cleaned_text[1])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   element_id    word_count            sd ave_sentiment \n    1.0000000   382.0000000     0.3115586     0.1770496 \n```\n:::\n:::\n\n\n# Word-level\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncal_sentiment <- \\(x) {\n    x %>%\n        filter(value == 0) %>%\n        pull(value) %>%\n        length() -> neu\n\n    x %>%\n        filter(value > 0) %>%\n        pull(value) %>%\n        sum() -> pos\n\n    x %>%\n        filter(value < 0) %>%\n        pull(value) %>%\n        sum() -> neg\n    result <- c(neu, pos, neg)\n\n    names(result) <- c(\"neu\", \"pos\", \"neg\")\n\n    return(result)\n}\n\nget_sentiment_word <- \\(x) {\n    result <- x %>%\n        tibble(text = ., id = 1) %>%\n        unnest_tokens(word, text) %>%\n        filter(!word %in% stopwords::stopwords(source = \"stopwords-iso\")) %>%\n        left_join(get_sentiments(\"afinn\")) %>% # you can try different dict\n        replace_na(list(value = 0)) %>%\n        nest(data = !id) %>%\n        mutate(sentiment = map(data, cal_sentiment)) %>%\n        pull(sentiment) %>%\n        unlist()\n\n    return(result)\n}\n```\n:::\n\n\nTry it:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_sentiment_word(data$cleaned_text[1])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nneu pos neg \n138  18 -12 \n```\n:::\n:::\n\n\n# Using these functions in loop\n\nYou can use these function with `for` loop or just use `map`to apply a them to each element of a vector or list in tibble.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data %>%\n    mutate(sentiment_asent = map(cleaned_text, get_sentiment_asent, .progress = TRUE))\n```\n:::",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\r\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\r\n<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}